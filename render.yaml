# Render Blueprint - Engineering Metrics Dashboard
# https://render.com/docs/blueprint-spec
#
# IMPORTANT: Render Workflows are created via the Render Dashboard, not via this file.
# To deploy the workflow:
#   1. Go to Render Dashboard > New > Workflow
#   2. Link this repository
#   3. Set Build Command: pip install -r requirements.txt
#   4. Set Start Command: python main.py
#   5. Configure environment variables (including DATABASE_URL from the database below)
#
# The cron jobs below are for triggering the workflow on a schedule.
# They use the Render API to run the `run_metrics_pipeline` task.

databases:
  # PostgreSQL database for storing metrics data
  - name: metrics-db
    plan: basic-256mb
    databaseName: engineering_metrics
    user: metrics_user

services:
  # Web service for API and Dashboard
  - type: web
    name: metrics-dashboard-web
    runtime: python
    plan: free
    buildCommand: pip install -r requirements.txt && alembic upgrade head
    startCommand: uvicorn api_main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.0"
      - key: DATABASE_URL
        fromDatabase:
          name: metrics-db
          property: connectionString
      # Required for backfill feature to trigger workflows
      - key: RENDER_API_KEY
        sync: false
      - key: RENDER_WORKFLOW_SLUG
        sync: false

  # Cron job to trigger weekly metrics workflow
  - type: cron
    name: trigger-weekly-metrics
    runtime: python
    schedule: "0 9 * * 1"  # Every Monday at 9 AM UTC
    buildCommand: pip install render_sdk httpx python-dotenv
    startCommand: python scripts/trigger_workflow.py weekly
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.0"
      - key: RENDER_API_KEY
        sync: false
      - key: WORKFLOW_SERVICE_ID
        sync: false

  # Cron job to trigger monthly metrics workflow
  - type: cron
    name: trigger-monthly-metrics
    runtime: python
    schedule: "0 9 1 * *"  # First day of each month at 9 AM UTC
    buildCommand: pip install render_sdk httpx python-dotenv
    startCommand: python scripts/trigger_workflow.py monthly
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.0"
      - key: RENDER_API_KEY
        sync: false
      - key: WORKFLOW_SERVICE_ID
        sync: false

# Environment variables needed for the Workflow service (set in Dashboard):
#
# Required:
#   - DATABASE_URL: PostgreSQL connection string (link to metrics-db)
#   - GITHUB_TOKEN: GitHub personal access token
#   - GITHUB_ORG: GitHub organization name
#   - INCIDENT_IO_API_KEY: incident.io API key
#
# Optional:
#   - SLACK_WEBHOOK_URL: Slack webhook for notifications
